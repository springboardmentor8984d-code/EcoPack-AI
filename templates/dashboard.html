<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoPackAI | Analytics</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="bg-light">

<div class="d-flex">
    <div class="sidebar p-4 d-flex flex-column shadow-sm bg-white" style="width: 260px; min-height: 100vh;">
        <a class="navbar-brand fw-bold mb-5 fs-4" href="/">
            <i class="bi bi-box-seam-fill text-success me-2"></i>EcoPack<span class="text-dark">AI</span>
        </a>
        <ul class="nav flex-column gap-3">
            <li class="nav-item"><a href="/" class="nav-link text-dark"><i class="bi bi-broadcast-pin me-3"></i>Predictor</a></li>
            <li class="nav-item"><a href="/dashboard" class="nav-link text-success fw-bold"><i class="bi bi-bar-chart-line-fill me-3"></i>Live Analytics</a></li>
        </ul>
    </div>

    <div class="flex-grow-1 p-5" id="report-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold">Live Sustainability Control Center</h2>
                <p class="text-muted">Real-time telemetry from your AI predictions.</p>
            </div>
            <div>
                <button id="export-btn" class="btn btn-outline-success shadow-sm me-2" onclick="exportPDF()">
                    <i class="bi bi-download me-2"></i>Export PDF
                </button>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="card border-0 shadow-sm p-4 text-center">
                    <h6 class="text-muted fw-bold">Total CO₂ Saved</h6>
                    <h2 class="text-success fw-bold mt-2" id="k-co2">-- kg</h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm p-4 text-center">
                    <h6 class="text-muted fw-bold">Total Cost Savings</h6>
                    <h2 class="text-primary fw-bold mt-2" id="k-cost">₹--</h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm p-4 text-center">
                    <h6 class="text-muted fw-bold">Avg. Reduction</h6>
                    <h2 class="text-dark fw-bold mt-2">28.4%</h2>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm p-4 h-100">
                    <h6 class="fw-bold mb-3">Live Emission Trends</h6>
                    <div id="tChart" style="height: 350px;"></div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm p-4 h-100">
                    <h6 class="fw-bold mb-3">Material Adoption</h6>
                    <div id="mChart" style="height: 350px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<footer class="text-center py-3 mt-4 border-top">
    <p class="mb-0">&copy; This is an AI Information, Always check out to avoid issues.</p>
</footer>
</div>
<script>
// ==========================================
// REAL-TIME DASHBOARD ENGINE
// ==========================================
function fetchLiveAnalytics() {
    fetch('/api/v1/analytics?t=' + new Date().getTime())
    .then(res => {
        if (!res.ok) throw new Error("Backend not ready");
        return res.json();
    })
    .then(data => {
        // Update KPIs
        document.getElementById('k-co2').innerText = data.kpis.co2.toLocaleString() + ' kg';
        document.getElementById('k-cost').innerText = '₹' + data.kpis.savings.toLocaleString();
        
        // Render/Update Charts Smoothly
        Plotly.react('mChart', data.charts.mat.data, data.charts.mat.layout, {displayModeBar: false, responsive: true});
        Plotly.react('tChart', data.charts.trend.data, data.charts.trend.layout, {displayModeBar: false, responsive: true});
    })
    .catch(err => console.error("Waiting for prediction data...", err));
}

// Fetch immediately, then poll every 3 seconds
fetchLiveAnalytics();
setInterval(fetchLiveAnalytics, 3000);

// PDF Export
// ==========================================
// Handle PDF Generation (Without the Button!)
// ==========================================
function exportPDF() {
    const element = document.getElementById('report-content');
    const btn = document.getElementById('export-btn');
    
    // 1. Hide the button (guard in case it's not found)
    if (btn) btn.style.display = 'none';

    // 2. Generate the PDF
    html2pdf().set({
        margin: 0.5,
        filename: 'EcoPack_Live_Report.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' }
    }).from(element).save().then(() => {
        // 3. Bring the button back immediately after the PDF is saved!
        if (btn) btn.style.display = 'block';
    });
}

</script>
</body>
</html>